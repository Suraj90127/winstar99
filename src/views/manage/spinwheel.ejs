<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Task Control</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/dist/css/adminlte.min.css" />
    <link rel="stylesheet" href="/css/admin.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7ff;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }
      .header {
        font-size: 2rem;
        font-weight: bold;
        color: #4a4eff;
        text-align: center;
        margin-bottom: 2rem;
      }
      .button {
        padding: 0.75rem 1.25rem;
        background-color: #4a4eff;
        margin-bottom: 10px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background-color 0.2s ease;
      }
      .button:hover {
        background-color: #3c3cbf;
      }
      .button-danger {
        background-color: #ff4e4e;
      }
      .button-danger:hover {
        background-color: #cc3d3d;
      }
      .input {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        width: 100%;
      }
      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border: 1px solid #eee;
        border-radius: 8px;
        background-color: #f9faff;
        margin-bottom: 0.75rem;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .task-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .task-list,
      .winning-section {
        margin-top: 2rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .section-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        border-radius: 8px;
        background-color: #4a4eff;
        color: white;
        font-weight: bold;
      }
      .section-item input {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        border: none;
        width: 80%;
      }
      @media screen and (max-width: 768px) {
        .button {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <!-- Include navigation -->
      <%- include('nav') %>
      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1
                  class=""
                  style="color: #605bff; font-size: 2rem; font-weight: bold"
                >
                  Admin Task Control
                </h1>
              </div>
            </div>
          </div>
        </section>

        <!-- Main content -->
        <section class="content">
          <div class="container">
            <!-- Instructions Section -->
            <div class="instructions-section">
              <button onclick="toggleDropdown()" class="button">
                <i class="fas fa-info-circle"></i> Instructions
              </button>
              <div
                id="instructionsDropdown"
                style="display: none; margin-top: 1rem"
              >
                <p>
                  Configure task numbers and winning amounts for the wheel spin
                  game.
                </p>
              </div>
            </div>

            <!-- Task Section -->
            <div class="task-section">
              <h2>Task List</h2>
              <div style="display: flex; gap: 1rem; margin-bottom: 1rem">
                <input
                  type="text"
                  id="taskAmount"
                  class="input"
                  placeholder="Task Amount"
                />
                <input
                  type="text"
                  id="numberofSpin"
                  class="input"
                  placeholder="Number of Spins"
                />
                <button onclick="addTask()" class="button">
                  <i class="fas fa-plus-circle"></i> Add
                </button>
              </div>
              <div id="taskList" class="task-list"></div>
            </div>

            <!-- Winning Amount Section -->
            <div class="winning-section">
              <h2>Winning Amount</h2>
              <div class="grid" id="sections"></div>
              <div style="display: flex; gap: 1rem; margin-top: 1rem">
                <button
                  onclick="updateWinningAmounts()"
                  class="button"
                  style="background: #0213a6"
                >
                  <i class="fas fa-edit"></i> Update
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      const tasks = [];
      const sections = Array(8)
        .fill(null)
        .map((_, i) => ({
          id: i + 1,
          value: i === 8 ? "NA" : (i + 1) * 10,
        }));

      function toggleDropdown() {
        const dropdown = document.getElementById("instructionsDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      async function addTask() {
    const taskAmount = document.getElementById("taskAmount").value;
    const numberofSpin = document.getElementById("numberofSpin").value;

    if (taskAmount && numberofSpin) {
        

        

        // Send data to the backend
        try {
            const response = await fetch("/api/webapi/admin/spinset", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include", // Send cookies with request
                body: JSON.stringify({ taskAmount, numberofSpin })
            });

            const result = await response.json();
            if (result.status) {
                alert("Task updated successfully!");
                    tasks.push({ id: tasks.length + 1, taskAmount, numberofSpin });
          renderTasks();
          // Store the values in localStorage
          localStorage.setItem("taskAmount", taskAmount);
          localStorage.setItem("numberofSpin", numberofSpin);
            } else {
                alert("Failed to update task: " + result.message);
            }
        } catch (error) {
            console.error("Error updating task:", error);
            alert("An error occurred while updating the task.");
        }
    } else {
        alert("Please enter both Task Amount and Number of Spins.");
    }
}


      function renderTasks() {
        const taskList = document.getElementById("taskList");
        console.log("ddd",tasks)
        taskList.innerHTML = tasks
          .map(
            (task) =>
              `<div class="task-item">
                      <span>Task: ${task.taskAmount}</span>
                      <span>Spins: ${task.numberofSpin}</span>
                      <button onclick="deleteTask(${task.id})" class="button button-danger">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </div>`
          )
          .join("");
      }

      function deleteTask(id) {
        const index = tasks.findIndex((task) => task.id === id);
        if (index > -1) {
          tasks.splice(index, 1);
          renderTasks();
        }
      }

      function renderSections() {
        const sectionsContainer = document.getElementById("sections");
        sectionsContainer.innerHTML = sections
          .map(
            (section) =>
              `<div class="section-item">
                      <span>Section ${section.id}</span>
                      <input type="text" value="${section.value}" onchange="updateSectionValue(${section.id}, this.value)" />
                    </div>`
          )
          .join("");
      }

      renderSections();

      let spinDataId = null; // To store the ID of the spin data

      // Fetch spin data on page load
      document.addEventListener("DOMContentLoaded", () => {
        fetchSpinData();
        // Retrieve values from localStorage
        const storedTaskAmount = localStorage.getItem("taskAmount");
        const storedNumberOfSpin = localStorage.getItem("numberofSpin");
        
         tasks.push({ id: tasks.length + 1,taskAmount:storedTaskAmount, numberofSpin:storedNumberOfSpin });
       renderTasks();
        if (storedTaskAmount) {
          document.getElementById("taskAmount").value = storedTaskAmount;
        }
        if (storedNumberOfSpin) {
          document.getElementById("numberofSpin").value = storedNumberOfSpin;
        }
      });

      // Fetch spin data from the API
      function fetchSpinData() {
        $.ajax({
          url: "/api/webapi/get-spin-data",
          type: "GET",
          contentType: "application/json",
          success: function (response) {
            console.log("rrrrrrrrrrrr", response.data.rows[0]);
            if (response.status && response.data.rows.length > 0) {
              const spinData = response.data.rows[0];
              spinDataId = spinData.id; // Store the ID for updates
              // Populate task fields
              document.getElementById("taskAmount").value =
                spinData.task_amount;
              document.getElementById("numberofSpin").value =
                spinData.num_of_spin;
              // Store the fetched values in localStorage
              localStorage.setItem("taskAmount", spinData.task_amount);
              localStorage.setItem("numberofSpin", spinData.num_of_spin);
              
              
       
                
                 
                 
              // Populate section fields
              sections.forEach((section, index) => {
                section.value = spinData[`sec${index + 1}`];
              });
              renderSections();
            }
          },
          error: function (xhr, status, error) {
            console.error("Error fetching spin data:", xhr.responseText);
          },
        });
      }

      // Update winning amounts
      function updateWinningAmounts() {
        const data = {
          taskAmount: document.getElementById("taskAmount").value,
          numberofSpin: document.getElementById("numberofSpin").value,
          sec1: sections[0].value,
          sec2: sections[1].value,
          sec3: sections[2].value,
          sec4: sections[3].value,
          sec5: sections[4].value,
          sec6: sections[5].value,
          sec7: sections[6].value,
          sec8: sections[7].value,
          id: 1, // Include the ID for updates
        };

        // console.log("dataaaaa", data);

        $.ajax({
          url: "/admin/manager/set-spin-data",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            if (response.status) {
              Swal.fire({
                icon: "success",
                title: "Success!",
                text: "Winning amounts updated successfully!",
              });
            }
          },
          error: function (xhr, status, error) {
            console.error("Error updating winning amounts:", xhr.responseText);
            Swal.fire({
              icon: "error",
              title: "Error!",
              text: "Failed to update winning amounts.",
            });
          },
        });
      }

      // Update section value
      function updateSectionValue(id, value) {
        const section = sections.find((s) => s.id === id);
        if (section) {
          section.value = value;
        }
      }
    </script>
      <script src="/plugins/jquery/jquery.min.js"></script>
      <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
      <script src="/dist/js/adminlte.min.js"></script>
      <script src="/js/admin/admin.js"></script>
      <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    </body>
</html>
