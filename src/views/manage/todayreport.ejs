<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Today Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
    <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <link rel="stylesheet" href="/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #818cf8;
            --accent: #4f46e5;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin: 1rem;
            padding: 2rem;
        }

        .header-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-input {
            flex: 1 1 200px; /* Adjusted for better responsiveness */
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .success-badge {
            background: #dcfce7;
            color: #166534;
        }

        .warning-badge {
            background: #fef9c3;
            color: #854d0e;
        }

        .danger-badge {
            background: #fee2e2;
            color: #991b1b;
        }

        .export-btn1 {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            
        }

        .export-btn1:hover {
            background: var(--accent);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .glass-container {
                margin: 0.5rem;
                padding: 1rem;
            }

            .filter-section {
                flex-direction: column;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }

            .filter-input {
                flex: 1 1 100%; /* Full width on small devices */
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <%- include('nav') %>
        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0" style="color: var(--primary); font-weight: 700;">Today Report</h1>
                        </div>
                    </div>
                </div>
            </section>

            <div class="glass-container animate-fade-in">
                <div class="header-gradient">
                    <h1>Today's Report Dashboard</h1>
                </div>

                <div class="filter-section">
                    <input type="text" class="filter-input" placeholder="Search by ID..."
                        oninput="value=value.replace(/\D/g,'')" id="ids">

                    <select class="filter-input" id="type">
                        <option value="recharge">Recharge</option>
                        <option value="withdraw">Withdraw</option>
                        <option value="bet">Bet</option>
                        <option value="win">Winner</option>
                        <option value="loss">Losser</option>
                    </select>

                    <input type="date" class="filter-input" id="dsearch">

                    <button class="export-btn1" id="searchSec">
                        <i class="fas fa-search"></i>
                        Search Records
                    </button>
                </div>

                <div class="card">
                    <div class=" " style="display: flex; justify-content: space-between; padding: 10px;">
                        <h3 class="card-title">Transaction Records</h3>
                        <button type="button" class="btn btn-light" id="exportButton">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="table1">
                            <thead id="datahead"></thead>
                            <tbody id="recharge"></tbody>
                        </table>
                    </div>
                </div>

                <nav aria-label="Page navigation" class="my-4">
                    <ul class="pagination justify-content-center table1 ">
                        <li class="page-item previous">
                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                        </li>
                        <div id="numbers" class="d-flex"></div>
                        <li class="page-item next">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/dist/js/adminlte.min.js"></script>
    <script src="/js/admin/admin.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

    
    <!-- <script>
        // Add loading state handling
        function toggleLoading(show) {
            $('.loading-overlay').css('display', show ? 'flex' : 'none');
        }

        // Enhanced AJAX handling
        function fetchData(url, data, callback) {
            toggleLoading(true);
            $.ajax({
                type: "POST",
                url: url,
                data: data,
                dataType: "json",
                success: function(response) {
                    callback(response.data);
                    toggleLoading(false);
                },
                error: function() {
                    toggleLoading(false);
                    Swal.fire('Error', 'Failed to fetch data', 'error');
                }
            });
        }

        // Rest of your JavaScript functions remain the same with minor styling adjustments
        // ... [Keep your existing JavaScript functions here] ...
        
        // Update your AJAX calls to use the fetchData function
        $('#search').click(function() {
            const fdate = $('#dsearch').val().trim();
            const type = $('#type').val().trim();
            const endpoint = "/api/webapi/admin/todayreport";
            
            fetchData(endpoint, { date: fdate, type: type }, function(data) {
                if(type === 'recharge') {
                    rechargeshow(data);
                } else if(type === 'withdraw') {
                    withdrawshow(data);
                } else {
                    show(data);
                }
            });
        });
    </script> -->


    <script>
        function formateT(params) {
            let result = (params < 10) ? "0" + params : params;
            return result;
        }
        
        function timerJoin(params = '') {
            let date = '';
            if (params) {
                date = new Date(Number(params));
            } else {
                date = new Date();
            }
            let years = formateT(date.getFullYear());
            let months = formateT(date.getMonth() + 1);
            let days = formateT(date.getDate());
            return years + '-' + months + '-' + days;
        }
        function show(params) {
        let heading=`<tr>
                     <th class="text-center">#</th>
                      <th class="text-center">Userid</th>
                      <th class="text-center">Game Name</th>
                      <th class="text-center">Amount.</th>
                      <th class="text-center">Win</th>
                      <th class="text-center">Date</th>
                      <th class="text-center">Status</th>
                    </tr>`
        let bets = '';
        params.map((data) => {
                bets += `<tr class="text-center">
                            <td id="${data.id}">${data.id}</td>
                            <td><b>${data.phone}</b></td>
                            <td><b>${data.source}-${data.game}</b></td>
                            <td style="min-width: 190px;"><b>${formatMoney(data.money)}</b></td>
                            <td style="min-width: 190px;"><b>${formatMoney(data.get)}</b></td>
                            <td><b>${data.date}</b></td>
                            <td style="min-width: 190px;"><span class="badge badge-${data.status === 1 ? 'success' : 'danger'}">${data.status === 1 ? 'Winner' : 'Looser'}</span></td>
                         </tr>`;
        });
        $('#datahead').html(heading);
        $('#recharge').html(bets);
    }
    
     function withdrawshow(params) {
        let heading=`<tr>
                      <th class="text-center">#</th>
                     <th class="text-center">Account</th>
                      <th class="text-center">Bank</th>
                      <th class="text-center">Account Number</th>
                       <th class="text-center">IFSC Code</th>
                      <th class="text-center">Cardholder Name</th>
                      <th class="text-center">Amount</th>
                      <th class="text-center">Status</th>
                      <th class="text-center">Date</th>
                    </tr>`;
        
          if(!params || params.length <= 0) {
            $('#recharge').html(`
                <tr class="text-center">
                  <td colspan="7">No more data available...</td>
                </tr>
              `);
            return;
          }
          let recharge = '';
          params.map((data) => {
            recharge += `<tr class="text-center">
                      <td id="${data.id}">
                        ${data.id}
                      </td>
                      <td>
                        <b>${data.phone}</b>
                      </td>
                      <td>
                        <b>${data.name_bank}</b>
                      </td>
                      <td style="min-width: 190px;">
                        <b>${data.stk}</b>
                      </td>
                      <td style="min-width: 190px;">
                      <b>${data.ifsc !== '' && data.ifsc !== null ? data.ifsc : ''}</b>
                      </td>
                      
                      <td style="min-width: 190px;">
                        <b>${data.name_user}</b>
                      </td>
                      <td>
                        <b>${formatMoney(data.money)}</b>
                      </td>
                      <td class="project-state">
                        <span class="badge badge-warning">Waiting...</span>
                      </td>
                      <td>
                        <b>${(data.today)}</b>
                      </td>
                    </tr>`;
            });
            $('#recharge').html(recharge);
            $('#datahead').html(heading);
        }
        
        function rechargeshow(params) {
        let heading=`<tr>
                      <th class="text-center">#</th>
                      <th class="text-center">Account</th>
                      <th class="text-center">Type</th>
                      <th class="text-center">Amount</th>
                      <th class="text-center">UTR</th>
                      <th class="text-center">Time</th>
                      <th class="text-center">Status</th>
                    </tr>`;
        
          if(!params || params.length <= 0) {
            $('#recharge').html(`
                <tr class="text-center">
                  <td colspan="7">No more data available...</td>
                </tr>
              `);
            return;
          }
          let recharge = '';
          params.map((data) => {
            recharge += `<tr class="text-center">
                      <td id="${data.id}">
                        ${data.id}
                      </td>
                      <td>
                        <b>${data.phone}</b>
                      </td>
                      <td>
                        ${(data.type == 'bank') ? '<b style="color: #3498db">BANKING</b>' : '<b style="color: #a50064">MOMO</b>'}
                      </td>
                      <td>
                        <b>${formatMoney(data.money)}</b>
                      </td>
                     <td style="min-width: 190px;">
                      <b>${data.utr}</b>
                     </td>
                      <td style="min-width: 190px;">
                        <b>${data.today}</b>
                      </td>
                      <td class="project-state">
                        <span class="badge badge-${(data.status == 1) ? 'success' : 'danger'}">${(data.status == 1) ? 'Success' : 'Closed'}</span>
                      </td>
                    </tr>`;
            });
            $('#recharge').html(recharge);
            $('#datahead').html(heading);
        }
        
        const currentURL = window.location.href;
        // Parse the URL to get the search parameters
        const urlSearchParams = new URLSearchParams(window.location.searchSec);
        let today = false;
        if(urlSearchParams.size > 0){
           today = true;
        }
        
        $(window).on('load', function() {
        const currentDate = new Date().toISOString().slice(0, 10);
        $.ajax({
          type: "POST",
          url: "/api/webapi/admin/todayreport",
          data: {
          date:currentDate,
          type:'recharge',
          },
          dataType: "json",
          success: function (response) {
            rechargeshow(response.data)
          }
        });
        });
        
        $('#searchSec').click(function() {
        let fdate = $('#dsearch').val().trim();
        let type=$('#type').val().trim();
    
        if(type==='recharge')
        {
        $.ajax({
            type: "POST",
            url: "/api/webapi/admin/todayreport",
            data: {
                date: fdate,
                type:type,
            },
            dataType: "json",
            success: function(response) {
                rechargeshow(response.data);
            }
        });
        }
        else if(type==='withdraw')
        {
        $.ajax({
            type: "POST",
            url: "/api/webapi/admin/todayreport",
            data: {
                date: fdate,
                type:type,
            },
            dataType: "json",
            success: function(response) {
                withdrawshow(response.data);
            }
        });
        }
        else{
        $.ajax({
            type: "POST",
            url: "/api/webapi/admin/todayreport",
            data: {
                date: fdate,
                type:type,
            },
            dataType: "json",
            success: function(response) {
                show(response.data);
            }
        });
        }
    });
    
    
      </script>
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    
      <script>
    function exportToExcel() {
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.table_to_sheet(document.getElementById('table1'));
         for (var r = 1; r <= ws['!ref'].split(':')[1].substring(1); r++) {
            var cell_address = 'E' + r;
            var cell = ws[cell_address];
            if (cell) {
                cell.t = 's'; // Set data type as string
                cell.v = '' + cell.v;
            }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'Recharge Data');
        XLSX.writeFile(wb, 'export_data.xlsx');
    }
    function handleExportClick() {
        exportToExcel();
    }
    document.getElementById('exportButton').addEventListener('click', handleExportClick);
    
    
    
    
    $('#downloadData').click(function () {
        let datess = $('#dsearch').val().trim(); // Get the date value
        let id = $("#ids").val().trim(); // Get the ID value
    
        $.ajax({
            type: "POST",
            url: "/api/webapi/getDataRecharge",
            data: JSON.stringify({
                id: id,
                date: datess
            }),
            contentType: 'application/json',
            xhrFields: {
                responseType: 'blob' // Ensures the response is treated as a file
            },
            success: function (response) {
                // Create a blob object from the response
                const blob = new Blob([response], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                const url = window.URL.createObjectURL(blob);
    
                // Create a temporary link and trigger a download
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'RechargeWithdrawData.xlsx'); // File name
                document.body.appendChild(link);
                link.click();
    
                // Clean up the link element
                link.remove();
    
                alert("Data downloaded successfully");
            },
            error: function (xhr, status, error) {
                console.error("Error downloading data:", error);
                alert("Failed to download data. Please try again.");
            }
        });
    });
    
        
      </script>
</body>
</html>